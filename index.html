<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Travel Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Relative:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Relative', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            background: #f5f5f5;
            color: #161616;
        }

        .app-container {
            height: 100vh;
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 0;
        }

        /* Side Panels */
        .side-panel {
            background: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .panel-header {
            padding: 24px 24px 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
        }

        .panel-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #161616;
            margin-bottom: 12px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 14px;
            font-family: 'Relative', sans-serif;
            transition: all 0.2s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #0770e3;
            box-shadow: 0 0 0 3px rgba(7, 112, 227, 0.1);
        }

        .search-input::placeholder {
            color: #999;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .mode-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid #d0d0d0;
            background: white;
            color: #666;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: 'Relative', sans-serif;
        }

        .mode-btn:hover {
            border-color: #0770e3;
            color: #0770e3;
        }

        .mode-btn.active {
            background: #0770e3;
            border-color: #0770e3;
            color: white;
        }

        /* Search Results Dropdown */
        .search-results {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.visible {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s ease;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: #f5f5f5;
        }

        .result-name {
            font-size: 14px;
            font-weight: 500;
            color: #161616;
            margin-bottom: 2px;
        }

        .result-details {
            font-size: 12px;
            color: #666;
        }

        .loading-message, .no-results {
            padding: 16px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        /* Lists */
        .list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .empty-state {
            padding: 48px 24px;
            text-align: center;
            color: #999;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 14px;
            line-height: 1.5;
        }

        .location-item {
            padding: 16px 24px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.15s ease;
        }

        .location-item:hover {
            background: #fafafa;
        }

        .location-info {
            flex: 1;
            min-width: 0;
        }

        .location-name {
            font-size: 15px;
            font-weight: 500;
            color: #161616;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-type {
            font-size: 12px;
            color: #666;
            text-transform: capitalize;
        }

        .remove-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            transition: color 0.15s ease;
            font-size: 18px;
            line-height: 1;
        }

        .remove-btn:hover {
            color: #e3170a;
        }

        .count-badge {
            background: #f0f0f0;
            color: #666;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
            display: inline-block;
        }

        /* Map Container */
        .map-container {
            position: relative;
            height: 100vh;
            background: #d0e8f0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 14px;
            color: #666;
        }

        /* Leaflet marker styling */
        .custom-marker-visited {
            background: #0770e3;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .custom-marker-wishlist {
            background: #ff8000;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-content-wrapper {
            border-radius: 4px;
            padding: 0;
        }

        .leaflet-popup-content {
            margin: 16px;
            font-family: 'Relative', sans-serif;
        }

        .popup-name {
            font-size: 15px;
            font-weight: 600;
            color: #161616;
            margin-bottom: 4px;
        }

        .popup-type {
            font-size: 13px;
            color: #666;
            text-transform: capitalize;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 280px 1fr 280px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .side-panel {
                height: auto;
                max-height: 40vh;
            }

            .side-panel:last-child {
                display: none;
            }

            .map-container {
                height: 60vh;
            }
        }

        /* Scrollbar styling */
        .list-container::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 6px;
        }

        .list-container::-webkit-scrollbar-track,
        .search-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .list-container::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background: #d0d0d0;
            border-radius: 3px;
        }

        .list-container::-webkit-scrollbar-thumb:hover,
        .search-results::-webkit-scrollbar-thumb:hover {
            background: #999;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Search icon component
        function SearchIcon() {
            return (
                <svg className="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
            );
        }

        // Globe icon for empty state
        function GlobeIcon() {
            return (
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="2" y1="12" x2="22" y2="12"/>
                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                </svg>
            );
        }

        function TravelMap() {
            const [places, setPlaces] = useState([]);
            const [visitedSearchQuery, setVisitedSearchQuery] = useState('');
            const [wishlistSearchQuery, setWishlistSearchQuery] = useState('');
            const [visitedSearchResults, setVisitedSearchResults] = useState([]);
            const [wishlistSearchResults, setWishlistSearchResults] = useState([]);
            const [isSearchingVisited, setIsSearchingVisited] = useState(false);
            const [isSearchingWishlist, setIsSearchingWishlist] = useState(false);
            const [showVisitedResults, setShowVisitedResults] = useState(false);
            const [showWishlistResults, setShowWishlistResults] = useState(false);
            const [mode, setMode] = useState('visited'); // 'visited' or 'wishlist'
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);
            const visitedSearchTimeoutRef = useRef(null);
            const wishlistSearchTimeoutRef = useRef(null);

            // Load places from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('travelPlaces');
                if (saved) {
                    try {
                        setPlaces(JSON.parse(saved));
                    } catch (e) {
                        console.error('Error loading saved places:', e);
                    }
                }
            }, []);

            // Save places to localStorage
            useEffect(() => {
                localStorage.setItem('travelPlaces', JSON.stringify(places));
            }, [places]);

            // Initialize map
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;

                const map = L.map(mapRef.current, {
                    zoomControl: true,
                    minZoom: 2,
                    maxZoom: 10
                }).setView([30, 0], 2);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Add click handler to map
                map.on('click', async (e) => {
                    try {
                        // Reverse geocode to get location name
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}&zoom=10`
                        );
                        const data = await response.json();

                        // Get the most relevant name (city, state, or country)
                        const name = data.address?.city ||
                                   data.address?.town ||
                                   data.address?.village ||
                                   data.address?.state ||
                                   data.address?.country ||
                                   'Unknown Location';

                        const newPlace = {
                            id: Date.now(),
                            name: name,
                            displayName: data.display_name,
                            lat: e.latlng.lat,
                            lng: e.latlng.lng,
                            type: mode
                        };

                        setPlaces(prev => [...prev, newPlace]);
                    } catch (error) {
                        console.error('Reverse geocoding error:', error);
                    }
                });

                mapInstanceRef.current = map;

                return () => {
                    map.remove();
                    mapInstanceRef.current = null;
                };
            }, [mode]);

            // Update markers
            useEffect(() => {
                if (!mapInstanceRef.current) return;

                markersRef.current.forEach(marker => marker.remove());
                markersRef.current = [];

                places.forEach(place => {
                    const icon = L.divIcon({
                        className: `custom-marker-${place.type}`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });

                    const marker = L.marker([place.lat, place.lng], { icon }).addTo(mapInstanceRef.current);

                    marker.bindPopup(`
                        <div class="popup-name">${place.name}</div>
                        <div class="popup-type">${place.displayName || ''}</div>
                    `);

                    markersRef.current.push(marker);
                });

                // Fit bounds if there are places
                if (places.length > 0) {
                    const bounds = L.latLngBounds(places.map(p => [p.lat, p.lng]));
                    mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50], maxZoom: 5 });
                }
            }, [places]);

            // Search for locations using Nominatim
            const searchLocation = async (query, type) => {
                if (!query.trim()) {
                    if (type === 'visited') {
                        setVisitedSearchResults([]);
                        setShowVisitedResults(false);
                    } else {
                        setWishlistSearchResults([]);
                        setShowWishlistResults(false);
                    }
                    return;
                }

                if (type === 'visited') {
                    setIsSearchingVisited(true);
                    setShowVisitedResults(true);
                } else {
                    setIsSearchingWishlist(true);
                    setShowWishlistResults(true);
                }

                try {
                    const response = await fetch(
                        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`
                    );
                    const data = await response.json();

                    // Filter out only very specific non-location types (buildings, roads, etc)
                    // Everything else gets through (cities, countries, regions)
                    const filtered = data.filter(item => {
                        const placeType = item.class;

                        // Exclude these specific types
                        const excludeTypes = ['building', 'highway', 'railway', 'amenity', 'shop', 'leisure'];

                        return !excludeTypes.includes(placeType);
                    });

                    if (type === 'visited') {
                        setVisitedSearchResults(filtered);
                    } else {
                        setWishlistSearchResults(filtered);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    if (type === 'visited') {
                        setVisitedSearchResults([]);
                    } else {
                        setWishlistSearchResults([]);
                    }
                } finally {
                    if (type === 'visited') {
                        setIsSearchingVisited(false);
                    } else {
                        setIsSearchingWishlist(false);
                    }
                }
            };

            // Debounced search for visited
            useEffect(() => {
                if (visitedSearchTimeoutRef.current) {
                    clearTimeout(visitedSearchTimeoutRef.current);
                }

                visitedSearchTimeoutRef.current = setTimeout(() => {
                    searchLocation(visitedSearchQuery, 'visited');
                }, 300);

                return () => {
                    if (visitedSearchTimeoutRef.current) {
                        clearTimeout(visitedSearchTimeoutRef.current);
                    }
                };
            }, [visitedSearchQuery]);

            // Debounced search for wishlist
            useEffect(() => {
                if (wishlistSearchTimeoutRef.current) {
                    clearTimeout(wishlistSearchTimeoutRef.current);
                }

                wishlistSearchTimeoutRef.current = setTimeout(() => {
                    searchLocation(wishlistSearchQuery, 'wishlist');
                }, 300);

                return () => {
                    if (wishlistSearchTimeoutRef.current) {
                        clearTimeout(wishlistSearchTimeoutRef.current);
                    }
                };
            }, [wishlistSearchQuery]);

            // Add location from search
            const addLocation = (result) => {
                const newPlace = {
                    id: Date.now(),
                    name: result.name || result.display_name.split(',')[0],
                    displayName: result.display_name,
                    lat: parseFloat(result.lat),
                    lng: parseFloat(result.lon),
                    type: mode
                };

                // Check for duplicates
                const exists = places.some(p =>
                    p.name === newPlace.name && p.type === newPlace.type
                );

                if (!exists) {
                    setPlaces(prev => [...prev, newPlace]);
                }

                if (mode === 'visited') {
                    setVisitedSearchQuery('');
                    setShowVisitedResults(false);
                } else {
                    setWishlistSearchQuery('');
                    setShowWishlistResults(false);
                }
            };

            // Remove location
            const removeLocation = (id) => {
                setPlaces(prev => prev.filter(p => p.id !== id));
            };

            const visitedPlaces = places.filter(p => p.type === 'visited');
            const wishlistPlaces = places.filter(p => p.type === 'wishlist');

            return (
                <div className="app-container">
                    {/* Visited Panel */}
                    <div className="side-panel">
                        <div className="panel-header">
                            <h2>
                                Places I've Been <span className="count-badge">{visitedPlaces.length}</span>
                            </h2>
                            <div className="mode-toggle">
                                <button
                                    className={`mode-btn ${mode === 'visited' ? 'active' : ''}`}
                                    onClick={() => setMode('visited')}
                                >
                                    Add to Visited
                                </button>
                            </div>
                            <div className="search-container">
                                <SearchIcon />
                                <input
                                    type="text"
                                    className="search-input"
                                    placeholder="Search countries, cities..."
                                    value={visitedSearchQuery}
                                    onChange={(e) => setVisitedSearchQuery(e.target.value)}
                                    onFocus={() => visitedSearchQuery && setShowVisitedResults(true)}
                                    onBlur={() => setTimeout(() => setShowVisitedResults(false), 200)}
                                />
                                {showVisitedResults && (
                                    <div className="search-results visible">
                                        {isSearchingVisited && <div className="loading-message">Searching...</div>}
                                        {!isSearchingVisited && visitedSearchResults.length === 0 && visitedSearchQuery && (
                                            <div className="no-results">No locations found</div>
                                        )}
                                        {!isSearchingVisited && visitedSearchResults.map((result, idx) => (
                                            <div
                                                key={idx}
                                                className="search-result-item"
                                                onClick={() => addLocation(result)}
                                            >
                                                <div className="result-name">{result.name || result.display_name.split(',')[0]}</div>
                                                <div className="result-details">{result.display_name}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="list-container">
                            {visitedPlaces.length === 0 ? (
                                <div className="empty-state">
                                    <GlobeIcon />
                                    <p>Search and add places you've visited</p>
                                </div>
                            ) : (
                                visitedPlaces.map(place => (
                                    <div key={place.id} className="location-item">
                                        <div className="location-info">
                                            <div className="location-name">{place.name}</div>
                                        </div>
                                        <button
                                            className="remove-btn"
                                            onClick={() => removeLocation(place.id)}
                                            title="Remove"
                                        >
                                            ×
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>

                    {/* Map */}
                    <div className="map-container">
                        <div id="map" ref={mapRef}></div>
                    </div>

                    {/* Wishlist Panel */}
                    <div className="side-panel">
                        <div className="panel-header">
                            <h2>
                                My Wishlist <span className="count-badge">{wishlistPlaces.length}</span>
                            </h2>
                            <div className="mode-toggle">
                                <button
                                    className={`mode-btn ${mode === 'wishlist' ? 'active' : ''}`}
                                    onClick={() => setMode('wishlist')}
                                >
                                    Add to Wishlist
                                </button>
                            </div>
                            <div className="search-container">
                                <SearchIcon />
                                <input
                                    type="text"
                                    className="search-input"
                                    placeholder="Search countries, cities..."
                                    value={wishlistSearchQuery}
                                    onChange={(e) => setWishlistSearchQuery(e.target.value)}
                                    onFocus={() => wishlistSearchQuery && setShowWishlistResults(true)}
                                    onBlur={() => setTimeout(() => setShowWishlistResults(false), 200)}
                                />
                                {showWishlistResults && (
                                    <div className="search-results visible">
                                        {isSearchingWishlist && <div className="loading-message">Searching...</div>}
                                        {!isSearchingWishlist && wishlistSearchResults.length === 0 && wishlistSearchQuery && (
                                            <div className="no-results">No locations found</div>
                                        )}
                                        {!isSearchingWishlist && wishlistSearchResults.map((result, idx) => (
                                            <div
                                                key={idx}
                                                className="search-result-item"
                                                onClick={() => addLocation(result)}
                                            >
                                                <div className="result-name">{result.name || result.display_name.split(',')[0]}</div>
                                                <div className="result-details">{result.display_name}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="list-container">
                            {wishlistPlaces.length === 0 ? (
                                <div className="empty-state">
                                    <GlobeIcon />
                                    <p>Search and add places you want to visit</p>
                                </div>
                            ) : (
                                wishlistPlaces.map(place => (
                                    <div key={place.id} className="location-item">
                                        <div className="location-info">
                                            <div className="location-name">{place.name}</div>
                                        </div>
                                        <button
                                            className="remove-btn"
                                            onClick={() => removeLocation(place.id)}
                                            title="Remove"
                                        >
                                            ×
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TravelMap />, document.getElementById('root'));
    </script>
</body>
</html>
